# Dumping Cooking Data
This is the guide for dumping cooking data using scripts that simulates the cooking progress.

## Table of Contents
1. [Database Format](#database-format)
2. [Files](#files)
2. [System Requirements for Dumping](#system-requirements)
3. [Dumping with Savage's Script (Recommended)](#dumping-with-savages-script-recommended)
4. [Dumping with Brkirch's Script](#dumping-with-brkirchs-script)
5. [Check Integrity](#check-integrity)
6. [Other](#other)


## Database Format
The database files contains binary data for every possible recipe in the game. The database is split into 32 `*.db` files for multi processing.

#### Record
Each record in the database is 3 bytes, The layout of the bits is
```
ixhm ____ pppp pppp phhh hhh

# i - parity bit. Total number of 1s in the 3-byte (including parity bit) should be even
# x - crit bit. If set, the recipe has rng heart value
# h - hearty bit. If set, the recipe adds 4 instead of 12 when calculating crit heart
# m - monster extract bit. If set, the recipe might give hp=1
# _ - reserved for future use
# p - (9 bits), lower 9 bits of the price
# h - (7 bits), unsigned (base) heart value
```

The 3 bytes are stored as big-endian integer in the database file

#### Number of Recipes
There are 149 materials and 62 cooked ingredients that can be used in cooking. The 62 cooked ingredients require Prompt Entanglement to be held and cooked in the cooking pot (for example, `Roasted Endura Carrot`).

Furthermore, there are items than can be held and cooked, but won't match any recipe (for example, `Sheikah Slate` and `Paraglider`). These items are represented in the database as a single item `<Invalid>`

We also consider the empty slot as the item `<None>`, so that every recipe has 5 items.

For example, the recipe `Acorn + Roasted Endura Carrot + Paraglider` is broken down to 5 items:
```
- Acorn
- Roasted Endura Carrot
- Paraglider
- <None>
- <None>
```

We have `149 + 62 + 2 = 213` items total.

The number of recipes is `213 multichoose 5` (i.e. the number of ways to choose 5 things from 213 unique items, allowing repeats), or `binomial(213+5-1, 5)`

```
binomial(213+5-1, 5) = binomial(217, 5) = 3827930778
```
In conclution, we have around 3.8 billion recipes

## Files
These are what the files in this folder are for
|File|Description|
|-|-|
|README.md|Instruction and Documentation for dumping data|
|.python-version|Python version used by `pyenv`|
|requirements.txt|Python modules needed|
|constants.py|Generate constants to be used in python scripts|
|constants.js|Generated by constants.py, to be used in JS code|
|brkirch.py|A modified version of the recipe calculator made by brkirch|
|recipeData.json|Data used with `brkirch.py`|
|dump.py|Script to dump the data with brkirch's calculator|
|bundle.js|Savage's recipe calculator|
|savage.js|Wrapper script to use savage's calculator|
|dump.js|Script to dump the data with savage's calculator|
|hash.py|Script to generate hashes for the dumped data|
|hash.json|Correct hashes of the dumped database|
|diff.py|Script to generate differences between 2 databases|
|check.py|Script to check the integrity of the dump|

# System Requirements
Python is required. Creating a virtual environment is recommended. Use the following code to create a venv and install the dependencies
```
python -m venv venv
.\venv\Scripts\Activate # . /venv/bin/activate for non-windows
pip install -r requirements.txt
```

[NodeJS](https://nodejs.org/en/) is required if you are dumping with savage's calculator.

## Dumping with Savage's Script (Recommended)
**Note: Currently, the dump script stores the entire database in memory before saving it to disk. The peak memory usage is around 10-11GB**

This is the recommended way as it is around 5x faster than dumping with brkirch's script.
1. Have [NodeJS](https://nodejs.org/en/) and Python installed as described above. All commands below should be ran in the `dump` directory
2. Start dumping
    ```
    node dump.js
    ```
3. After the dump has finished, follow the instructions at [Check Integrity](#check-integrity)

## Dumping with Brkirch's Script
1. Have Python installed as described above. All commands below should be ran in the `dump` directory
2. Start dumping
    ```
    python dump.py
    ```
3. After the dump has finished, follow the instructions at [Check Integrity](#check-integrity)

## Check Integrity
It's recommended that you check the hashes of the dumped data before using

#### Hash Only
Checking hash only against correct hash is good enough to know that your dumped data is the correct
```
python check.py hash
```

#### All Checks
To run checks on individual record (such as making sure hp <= 120), run this
```
python check.py all
```

## Other
Other stuff for development
#### Other Scripts
- `python hash.py` to generate `hash.json` based on dumped data
- `python diff.py ../data_another` to compare 2 databases
#### Updateing Savage's script
1. `wget -O bundle.js https://raw.githubusercontent.com/savage13/cooking/main/bundle.js`
2. Change `export{CookingData,botw_sort};` to `exports.CookingData=CookingData;` at the end of the script
